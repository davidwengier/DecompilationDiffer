@page "/"
@inject NavigationManager navigationManager
@using System.Threading

<div class="banner">
    <span class="title">Decompilation Differ<span class="version"> - @ThisAssembly.AssemblyInformationalVersion</span></span>
    <span class="about">
        by <a target="_blank" href="https://twitter.com/davidwengier">@@davidwengier</a>
        - <a target="_blank" href="https://github.com/davidwengier/DecompilationDiffer">GitHub</a>
    </span>
</div>

<div class="parent">
    <div class="code-header"><span class="header">Base</span></div>
    <div class="code"><MonacoEditor @ref="codeEditor" Id="code-editor" ConstructionOptions="EditorConstructionOptions" OnKeyUp="OnKeyUp" /></div>
    <div class="generator-header"><span class="header">Version 1</span></div>
    <div class="generator"><MonacoEditor @ref="generator" Id="generator" ConstructionOptions="EditorConstructionOptions" OnKeyUp="OnKeyUp" /></div>
    <div class="generator-output-header">
        <span class="header">Decompilation Diff</span>
        <div class="refresh">
            <span>
                <input type="checkbox" @bind="_autoRefresh" /> Auto
            </span>
            <div class="btn btn-primary" @onclick="Refresh">
                <span>Refresh</span>
            </div>
        </div>
    </div>
    <div class="geneator-output"><MonacoDiffEditor @ref="generatorOutput" Id="generator-output" ConstructionOptions="DiffEditorConstructionOptions" /></div>
</div>

@code {
    private MonacoEditor codeEditor;
    private MonacoEditor generator;
    private MonacoEditor programOutput;
    private MonacoDiffEditor generatorOutput;
    private bool _autoRefresh = false;

    private DiffEditorConstructionOptions DiffEditorConstructionOptions(MonacoDiffEditor editor)
    {
        var options = new DiffEditorConstructionOptions
        {
            AutomaticLayout = true,
            Minimap = new MinimapOptions() { Enabled = false },
            Folding = false,
            RenderSideBySide = false,
            IgnoreTrimWhitespace = true,
            OriginalEditable = false,
            ReadOnly = true,
            LineNumbers = ""
        };

        return options;
    }

    private StandaloneEditorConstructionOptions EditorConstructionOptions(MonacoEditor editor)
    {
        var options = new StandaloneEditorConstructionOptions
        {
            AutomaticLayout = true,
            Language = "csharp",
            Minimap = new MinimapOptions() { Enabled = false },
            Folding = false,
        };

        if (editor == programOutput)
        {
            options.ReadOnly = true;
        }

        return options;
    }

    private CancellationTokenSource _typingCancellationSource = new CancellationTokenSource();

    private void Refresh()
    {
        _ = Update(default);
    }

    private void OnKeyUp(KeyboardEvent keyboardEvent)
    {
        // ignore arrow keys
        if (keyboardEvent.KeyCode == KeyCode.LeftArrow ||
            keyboardEvent.KeyCode == KeyCode.RightArrow ||
            keyboardEvent.KeyCode == KeyCode.UpArrow ||
            keyboardEvent.KeyCode == KeyCode.DownArrow ||
            keyboardEvent.KeyCode == KeyCode.PageUp ||
            keyboardEvent.KeyCode == KeyCode.PageDown)
        {
            return;
        }

        if (!_autoRefresh)
        {
            return;
        }

        _typingCancellationSource.Cancel();
        _typingCancellationSource = new CancellationTokenSource();
        _ = Update(_typingCancellationSource.Token);
    }

    private async Task Update(CancellationToken cancellationToken)
    {
        await Task.Delay(500, cancellationToken);

        if (cancellationToken.IsCancellationRequested)
        {
            return;
        }

        var runner = new Runner(await codeEditor.GetValue(), await generator.GetValue());

        await runner.Run(navigationManager.BaseUri);

        var baseOutput = runner.BaseOutput;
        var version1Output = runner.Version1Output;
        if (runner.ErrorText?.Length != 0)
        {
            baseOutput = version1Output = runner.ErrorText;
        }
        
        
        var originalModel = await MonacoEditorBase.CreateModel(baseOutput, "csharp");
        var modifiedModel = await MonacoEditorBase.CreateModel(version1Output, "csharp");

        await generatorOutput.SetModel(new DiffEditorModel
        {
            Original = originalModel,
            Modified = modifiedModel
        });
    }
}
